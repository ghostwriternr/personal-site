---
import { Image } from "astro:assets";
import ThemeToggle from "./ThemeToggle.astro";
import MeImage from "../assets/me.png";
import { getCollection } from "astro:content";

const links = [
    { label: "Blog", href: "/" },
    { label: "Poetry", href: "/poetry" },
    { label: "About", href: "/about" },
];

const readingList = await getCollection("nowReading");
const books = readingList.map(entry => entry.data);

const pathname = Astro.url.pathname.replace(import.meta.env.BASE_URL, "");
const subpath = pathname.match(/[^\/]+/g);

function isActive(href: string) {
    return (
        href === pathname ||
        href === "/" + (subpath?.[0] || "") ||
        (href === "/" && subpath?.[0] === "posts")
    );
}
---

<!-- Unified Navigation Container -->
<div
    class="border-theme-accent-dark bg-theme-background fixed top-0 left-0 z-50 flex w-full items-center justify-between p-4 md:h-screen md:w-20 md:flex-col md:border-r-4 md:bg-transparent md:p-0 md:pt-8 md:pb-8"
>
    <!-- Avatar -->
    <div class="flex-shrink-0 md:flex md:justify-center">
        <a href="/">
            <Image
                src={MeImage}
                alt="Avatar"
                class="w-10 cursor-pointer md:w-15"
                loading="eager"
            />
        </a>
    </div>

    <!-- Mobile: Wrapper for Nav + Theme + Book (right side) -->
    <!-- Desktop: Separate containers for Nav (middle) and Theme/Book (bottom) -->
    <div class="flex items-center gap-4 md:contents">
        <!-- Navigation Links -->
        <div class="flex items-center space-x-4 md:grow md:flex-col md:justify-center md:space-x-0 md:gap-24 md:py-8">
            {
                links.map((link) => {
                    const baseClasses =
                        "sidebar-link flex items-center justify-center transition-colors duration-100 text-[var(--color-text)]";
                    const responsiveClasses =
                        "text-body-lg md:h-20 md:-rotate-90 md:transform md:text-heading-sm";
                    const activeClasses = isActive(link.href)
                        ? "!text-primary font-bold"
                        : "";
                    return (
                        <a
                            href={link.href}
                            class={`${baseClasses} ${responsiveClasses} ${activeClasses}`}
                            aria-current={isActive(link.href) ? "page" : undefined}
                        >
                            <span>{link.label}</span>
                        </a>
                    );
                })
            }
        </div>

        <!-- Theme Toggle and Book -->
        <div class="flex items-center gap-4 md:flex-col md:gap-6">
        <ThemeToggle />

        {books.length > 0 && (
            <div
                id="now-reading-container"
                class="group relative flex items-center justify-center"
                data-books={JSON.stringify(books)}
                transition:persist="now-reading"
            >
                <!-- Book will be rendered by client-side script -->
            </div>
        )}
        </div>
    </div>
</div>

<script>
    function renderNowReading() {
        const container = document.getElementById('now-reading-container');
        if (!container || container.children.length > 0 || !container.dataset.books) return;

        const books = JSON.parse(container.dataset.books);
        if (books.length === 0) return;

        const SESSION_KEY = 'now-reading-index';
        let bookIndex = sessionStorage.getItem(SESSION_KEY);

        if (bookIndex === null || parseInt(bookIndex) >= books.length) {
            bookIndex = Math.floor(Math.random() * books.length).toString();
            sessionStorage.setItem(SESSION_KEY, bookIndex);
        }

        const book = books[parseInt(bookIndex)];
        if (!book) return;

        const link = document.createElement('a');
        link.href = book.url;
        link.target = '_blank';
        link.rel = 'noopener noreferrer';
        link.className = 'transition-transform duration-200 hover:scale-105 flex items-center justify-center';

        const bookDiv = document.createElement('div');
        bookDiv.className = 'w-6 h-9 md:w-8 md:h-12 bg-primary/5 rounded-sm overflow-hidden border border-primary/10 shadow-sm group-hover:border-secondary/50 transition-colors';

        if (book.cover) {
            const img = document.createElement('img');
            img.src = book.cover;
            img.alt = book.title;
            img.className = 'w-full h-full object-cover grayscale-[0.2] group-hover:grayscale-0 transition-all';
            bookDiv.appendChild(img);
        } else {
            const fallback = document.createElement('div');
            fallback.className = 'w-full h-full flex items-center justify-center text-[8px] text-center p-1 opacity-50';
            fallback.textContent = book.title;
            bookDiv.appendChild(fallback);
        }

        link.appendChild(bookDiv);

        const tooltip = document.createElement('div');
        tooltip.className = 'hidden md:block absolute top-1/2 left-full ml-4 -translate-y-1/2 px-3 py-2 bg-primary text-background text-xs rounded-md opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-50 shadow-xl border border-white/10';

        const title = document.createElement('div');
        title.className = 'font-bold';
        title.textContent = book.title;

        const author = document.createElement('div');
        author.className = 'opacity-70';
        author.textContent = `by ${book.author}`;

        const arrow = document.createElement('div');
        arrow.className = 'absolute top-1/2 -left-1 -translate-y-1/2 w-2 h-2 bg-primary rotate-45 border-l border-t border-white/10';

        tooltip.appendChild(title);
        tooltip.appendChild(author);
        tooltip.appendChild(arrow);

        container.appendChild(link);
        container.appendChild(tooltip);
    }

    renderNowReading();
</script>
