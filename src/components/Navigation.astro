---
import { Image } from "astro:assets";
import ThemeToggle from "./ThemeToggle.astro";
import MeImage from "../assets/me.png";
import { getCollection } from "astro:content";

const links = [
    { label: "Blog", href: "/" },
    { label: "Poetry", href: "/poetry" },
    { label: "About", href: "/about" },
];

const readingList = await getCollection("nowReading");
const books = readingList
    .map((entry) => entry.data)
    .filter((book) => book.cover);

const pathname = Astro.url.pathname.replace(import.meta.env.BASE_URL, "");
const subpath = pathname.match(/[^\/]+/g);

function isActive(href: string) {
    return (
        href === pathname ||
        href === "/" + (subpath?.[0] || "") ||
        (href === "/" && subpath?.[0] === "posts")
    );
}
---

<!-- Unified Navigation Container --><!-- Mobile/Tablet (<1280px): Horizontal top bar --><!-- Desktop (>=1280px): Vertical sidebar -->
<div
    class="no-select border-theme-accent-dark bg-theme-background fixed top-[10px] left-0 z-50 flex w-full items-center justify-between p-4 xl:top-0 xl:h-screen xl:w-24 xl:flex-col xl:border-t-[10px] xl:border-r-[10px] xl:border-b-[10px] xl:bg-transparent xl:p-0 xl:pt-6 xl:pb-6"
>
    <!-- Avatar -->
    <div class="flex-shrink-0 xl:flex xl:justify-center">
        <a href="/">
            <Image
                src={MeImage}
                alt="Avatar"
                class="w-10 xl:w-15"
                loading="eager"
            />
        </a>
    </div>

    <!-- Mobile/Tablet: Wrapper for Nav + Theme + Book (right side) -->
    <!-- Desktop: Separate containers for Nav (middle) and Theme/Book (bottom) -->
    <div class="flex items-center gap-4 xl:contents">
        <!-- Navigation Links -->
        <div
            class="flex items-center space-x-4 xl:grow xl:flex-col xl:justify-center xl:gap-24 xl:space-x-0 xl:py-8"
        >
            {
                links.map((link) => {
                    const baseClasses =
                        "sidebar-link flex items-center justify-center transition-colors duration-100 text-[var(--color-text)] hover:text-[var(--color-secondary)] font-bold";
                    const responsiveClasses =
                        "text-base xl:h-20 xl:-rotate-90 xl:transform xl:text-heading-sm";
                    const activeClasses = isActive(link.href)
                        ? "!text-primary font-bold"
                        : "";
                    return (
                        <a
                            href={link.href}
                            class={`${baseClasses} ${responsiveClasses} ${activeClasses}`}
                            aria-current={
                                isActive(link.href) ? "page" : undefined
                            }
                        >
                            <span>{link.label}</span>
                        </a>
                    );
                })
            }
        </div>

        <!-- Theme Toggle and Book -->
        <div class="flex items-center gap-4 xl:flex-col xl:gap-6">
            <ThemeToggle />

            {/* Book container - fixed size to prevent layout shift while JS selects the book */}
            {
                books.length > 0 && (
                    <div
                        id="now-reading-container"
                        class="group relative h-9 w-6 xl:h-12 xl:w-8"
                    >
                        {books.map((book, i) => (
                            <div
                                class="book-option absolute inset-0 hidden"
                                data-index={i}
                            >
                                <a
                                    href={book.url}
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    class="flex h-full w-full items-center justify-center transition-transform duration-200 hover:scale-105"
                                >
                                    <div class="bg-primary/5 border-primary/10 group-hover:border-secondary/50 h-full w-full overflow-hidden rounded-sm border shadow-sm transition-colors">
                                        <img
                                            src={book.cover}
                                            alt={book.title}
                                            class="h-full w-full object-cover grayscale-[0.2] transition-all group-hover:grayscale-0"
                                        />
                                    </div>
                                </a>
                                <div class="bg-primary text-background pointer-events-none absolute top-1/2 left-full z-50 ml-4 hidden -translate-y-1/2 rounded-md border border-white/10 px-3 py-2 text-xs whitespace-nowrap opacity-0 shadow-xl transition-opacity group-hover:opacity-100 xl:block">
                                    <div class="font-bold">{book.title}</div>
                                    <div class="opacity-70">
                                        by {book.author}
                                    </div>
                                    <div class="bg-primary absolute top-1/2 -left-1 h-2 w-2 -translate-y-1/2 rotate-45 border-t border-l border-white/10" />
                                </div>
                            </div>
                        ))}
                    </div>
                )
            }
        </div>
    </div>
</div>

<script>
    // Select a random book per tab, persist across navigation within the same tab
    const container = document.getElementById("now-reading-container");
    if (container) {
        const bookOptions = container.querySelectorAll(".book-option");

        if (bookOptions.length > 0) {
            const SESSION_KEY = "now-reading-index";
            let bookIndex = sessionStorage.getItem(SESSION_KEY);

            if (
                bookIndex === null ||
                parseInt(bookIndex) >= bookOptions.length
            ) {
                bookIndex = Math.floor(
                    Math.random() * bookOptions.length
                ).toString();
                sessionStorage.setItem(SESSION_KEY, bookIndex);
            }

            bookOptions[parseInt(bookIndex)]?.classList.remove("hidden");
        }
    }
</script>
